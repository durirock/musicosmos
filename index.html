<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Musicosmos - Forja de Pulsares</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Arial', sans-serif;
            background-color: #000;
            color: white;
        }
        canvas { display: block; }
        #info {
            position: absolute;
            top: 10px;
            width: 100%;
            text-align: center;
            color: white;
            background-color: rgba(0,0,0,0.5);
            padding: 10px;
            z-index: 100;
            opacity: 1;
            transition: opacity 2s ease-in;
        }
        .fade-out {
            opacity: 0 !important;
            pointer-events: none;
        }
        #midiStatus, #coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 10px;
            z-index: 100;
            border-radius: 5px;
            font-family: monospace;
        }
        #coordinates {
            top: 10px;
            bottom: auto;
        }
        #teleportPanel {
            position: absolute;
            bottom: 60px;
            left: 10px;
            color: white;
            background-color: rgba(0,0,0,0.7);
            padding: 15px;
            z-index: 100;
            border-radius: 5px;
            display: none;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(100, 120, 255, 0.3);
            box-shadow: 0 0 15px rgba(100, 120, 255, 0.3);
        }
        #teleportPanel input { width: 60px; background-color: rgba(30,30,40,0.8); color: white; border: 1px solid #557; border-radius: 3px; padding: 5px; margin: 0 5px; font-family: monospace; }
        #teleportPanel button { background-color: #4466dd; color: white; border: none; border-radius: 3px; padding: 6px 12px; cursor: pointer; margin-left: 10px; }
        #teleportPanel button:hover { background-color: #5577ee; }
        .btn-settings, .btn-teleport, .btn-perspective {
            position: absolute;
            background-color: rgba(50,50,70,0.6);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            box-shadow: 0 0 10px rgba(100,100,255,0.5);
            z-index: 200;
        }
        .btn-settings { top: 20px; right: 20px; width: 50px; height: 50px; border-radius: 50%; font-size: 24px; }
        .btn-teleport { bottom: 20px; left: 10px; padding: 10px 15px; font-size: 14px; }
        .btn-perspective { bottom: 20px; right: 20px; padding: 10px 15px; font-size: 14px; }
        .btn-settings:hover, .btn-teleport:hover, .btn-perspective:hover { background-color: rgba(70,70,100,0.8); }
        #settingsMenu {
            position: absolute;
            top: 80px;
            right: 20px;
            width: 350px; /* Aumentado para más espacio */
            max-height: 80vh;
            overflow-y: auto;
            background-color: rgba(30, 30, 50, 0.85); 
            color: white;
            border-radius: 10px;
            padding: 0;
            box-shadow: 0 0 20px rgba(0,0,255,0.3);
            z-index: 200;
            display: none;
            backdrop-filter: blur(8px);
        }
        .settings-tabs { display: flex; border-bottom: 1px solid #557; background-color: rgba(40, 40, 60, 0.9); padding: 5px 5px 0 5px; border-top-left-radius: 10px; border-top-right-radius: 10px; }
        .tab-button { padding: 10px 15px; cursor: pointer; background-color: transparent; border: none; color: #aab; font-size: 14px; border-radius: 5px 5px 0 0; transition: background-color 0.3s, color 0.3s; outline: none; }
        .tab-button:hover { background-color: rgba(80, 80, 120, 0.5); color: #fff; }
        .tab-button.active { background-color: rgba(30, 30, 50, 0.9); color: #fff; border-bottom: 2px solid #4466dd; }
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.5s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* Estilos para Forja de Pulsares */
        #tab-pulsares h3 { margin-top: 0; color: #aaf; border-bottom: 1px solid #557; padding-bottom: 10px; }
        .forge-section { margin-bottom: 20px; }
        .forge-section h4 { color: #c7e5ff; margin-bottom: 10px; font-size: 1em; }
        .forge-controls, .coord-inputs { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; flex-wrap: wrap; }
        .forge-controls label, .coord-inputs label { font-size: 0.9em; }
        .forge-input, .coord-input {
            background-color: rgba(40,40,60,0.9);
            color: white;
            border: 1px solid #557;
            border-radius: 5px;
            padding: 8px;
            font-family: monospace;
        }
        .coord-input { width: 60px; }
        .forge-button {
            background-color: #4466dd;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .forge-button:hover { background-color: #5577ee; }
        .forge-button.secondary { background-color: #5a6688; }
        .forge-button.secondary:hover { background-color: #6b7799; }
        #loadedFilesList {
            background-color: rgba(15, 15, 25, 0.7);
            border: 1px solid #557;
            border-radius: 5px;
            padding: 10px;
            min-height: 50px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8em;
            margin-top: 10px;
        }
        #loadedFilesList div { padding: 3px 0; border-bottom: 1px solid #334; }
        #loadedFilesList div:last-child { border-bottom: none; }
        #file-upload-label {
            display: inline-block;
            padding: 10px 15px;
            background-color: #3a4a9c;
            color: white;
            border-radius: 5px;
            cursor: pointer;
        }
        #file-upload-label:hover { background-color: #4a5abf; }
        input[type="file"] { display: none; }
    </style>
</head>
<body>
    <div id="info">
        <h1>Musicosmos</h1>
        <p>Conecta un dispositivo MIDI y toca para crear galaxias musicales.</p>
        <p>Usa las teclas W, A, S, D para moverte, ratón para navegar en todas direcciones.</p>
    </div>
    
    <div id="midiStatus">Esperando conexión MIDI...</div>
    <div id="coordinates">X: 0.00, Y: 0.00, Z: 0.00</div>
    
    <button class="btn-teleport" id="btnTeleport">Teletransporte</button>
    <button class="btn-perspective" id="btnPerspective">Cambiar Vista</button>
    
    <div id="teleportPanel">
        <div>X: <input type="number" id="teleportX" step="10"></div>
        <div>Y: <input type="number" id="teleportY" step="10"></div>
        <div>Z: <input type="number" id="teleportZ" step="10"></div>
        <button id="btnGoToCoords">Ir</button>
    </div>
    
    <button class="btn-settings" id="btnSettings">⚙️</button>
    
    <div id="settingsMenu"> 
        <div class="settings-tabs">
            <button class="tab-button active" data-tab="tab-general">General</button>
            <button class="tab-button" data-tab="tab-playlist">Playlist</button>
            <button class="tab-button" data-tab="tab-pulsares">Forja de Pulsares</button>
        </div>
        
        <div id="tab-general" class="tab-content active">
            <h3>Configuración General</h3>
            <!-- Contenido de Configuración General -->
        </div>
        
        <div id="tab-playlist" class="tab-content">
            <h3>Playlist del Cosmos</h3>
             <!-- Contenido de Playlist -->
        </div>
        
        <div id="tab-pulsares" class="tab-content">
            <h3>Forja de Pulsares</h3>
            
            <div class="forge-section">
                <h4>1. Cargar Archivos de Audio</h4>
                <div class="forge-controls">
                    <label id="file-upload-label" for="audioFilesInput">Seleccionar Audios</label>
                    <input type="file" id="audioFilesInput" accept="audio/*" multiple>
                </div>
                <div id="loadedFilesList">Ningún archivo cargado.</div>
            </div>

            <div class="forge-section">
                <h4>2. Definir Origen y Diseño</h4>
                <div class="coord-inputs">
                    <label for="startX">X:</label>
                    <input type="number" id="startX" class="coord-input" value="0">
                    <label for="startY">Y:</label>
                    <input type="number" id="startY" class="coord-input" value="0">
                    <label for="startZ">Z:</label>
                    <input type="number" id="startZ" class="coord-input" value="0">
                </div>
                <div class="forge-controls">
                    <label for="designPattern">Patrón:</label>
                    <select id="designPattern" class="forge-input">
                        <option value="fibonacci">Espiral de Fibonacci</option>
                        <!-- Futuros patrones aquí -->
                    </select>
                </div>
            </div>

            <div class="forge-section">
                <h4>3. Crear y Gestionar</h4>
                <div class="forge-controls">
                    <button id="createDesignButton" class="forge-button">Forjar Diseño</button>
                </div>
                 <div class="forge-controls">
                    <button id="saveMapButton" class="forge-button secondary">Guardar Mapa</button>
                    <label for="loadMapInput" class="forge-button secondary">Cargar Mapa</label>
                    <input type="file" id="loadMapInput" accept=".json">
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // Variables globales y código de Musicosmos existente...
        let scene, camera, renderer, avatarObject, audioListener, audioContext;
        let galaxies = {}, gestorDePulsares = { activos: {} };
        let moveForward = false, moveBackward = false, moveLeft = false, moveRight = false, moveUp = false, moveDown = false;
        let yawAngle = 0, pitchAngle = 0;
        let currentViewMode = 'thirdPerson';
        let cameraOffset = new THREE.Vector3(0, 10, 20);
        let clock = new THREE.Clock();

        // **NUEVO**: Almacén para los archivos de audio cargados por el usuario
        let userAudioFiles = [];

        // --- INICIO DEL CÓDIGO DE MUSICOSMOS (adaptado) ---
        
        // Inicialización principal
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000011);
            scene.fog = new THREE.FogExp2(0x000011, 0.0004);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 10000);
            audioListener = new THREE.AudioListener();
            camera.add(audioListener);
            audioContext = audioListener.context;

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            createAvatar();
            
            // Event listeners
            window.addEventListener('resize', onWindowResize);
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            // ... otros listeners ...

            // **NUEVO**: Inicializar listeners para la Forja
            initPulsarForgeListeners();
            initTabs();

            document.getElementById('btnSettings').addEventListener('click', toggleSettingsMenu);
            document.getElementById('btnTeleport').addEventListener('click', toggleTeleportPanel);
            document.getElementById('btnGoToCoords').addEventListener('click', teleportToCoords);
            document.getElementById('btnPerspective').addEventListener('click', cycleViewMode);


            animate();
        }

        function createAvatar() {
            const geometry = new THREE.SphereGeometry(1, 16, 12);
            const material = new THREE.MeshPhongMaterial({ color: 0x4488ff, emissive: 0x112244 });
            avatarObject = new THREE.Mesh(geometry, material);
            scene.add(avatarObject);
        }

        // **NUEVO**: Inicializar los event listeners para la Forja de Pulsares
        function initPulsarForgeListeners() {
            const audioFilesInput = document.getElementById('audioFilesInput');
            const createDesignButton = document.getElementById('createDesignButton');
            const saveMapButton = document.getElementById('saveMapButton');
            const loadMapInput = document.getElementById('loadMapInput');

            audioFilesInput.addEventListener('change', handleAudioFilesSelect);
            createDesignButton.addEventListener('click', createDesignFromFiles);
            saveMapButton.addEventListener('click', savePulsarMap);
            loadMapInput.addEventListener('change', loadPulsarMap);
        }

        // **NUEVO**: Maneja la selección de archivos de audio
        function handleAudioFilesSelect(event) {
            userAudioFiles = Array.from(event.target.files);
            const listElement = document.getElementById('loadedFilesList');
            listElement.innerHTML = ''; // Limpiar lista
            if (userAudioFiles.length > 0) {
                userAudioFiles.forEach(file => {
                    const item = document.createElement('div');
                    item.textContent = file.name;
                    listElement.appendChild(item);
                });
            } else {
                listElement.textContent = 'Ningún archivo cargado.';
            }
        }

        // **NUEVO**: Función principal para crear el diseño de púlsares
        function createDesignFromFiles() {
            if (userAudioFiles.length === 0) {
                alert('Por favor, carga al menos un archivo de audio.');
                return;
            }

            const startX = parseFloat(document.getElementById('startX').value) || 0;
            const startY = parseFloat(document.getElementById('startY').value) || 0;
            const startZ = parseFloat(document.getElementById('startZ').value) || 0;
            const origin = new THREE.Vector3(startX, startY, startZ);

            const pattern = document.getElementById('designPattern').value;

            switch (pattern) {
                case 'fibonacci':
                    createFibonacciSpiral(origin, userAudioFiles);
                    break;
                // Aquí se pueden añadir más casos para otros patrones
            }
        }

        // **NUEVO**: Implementa el algoritmo de la espiral de Fibonacci en 3D
        function createFibonacciSpiral(origin, files) {
            const goldenAngle = Math.PI * (3 - Math.sqrt(5)); // ~137.5 grados en radianes
            const scaleFactor = 30; // Distancia entre púlsares

            files.forEach((file, i) => {
                const n = i + 1;
                const radius = Math.sqrt(n) * scaleFactor;
                const angle = n * goldenAngle;

                // Coordenadas X y Z para la espiral en el plano horizontal
                const x = origin.x + radius * Math.cos(angle);
                const z = origin.z + radius * Math.sin(angle);
                
                // Usamos el eje Y para darle altura, creando una espiral 3D ascendente
                const y = origin.y + (n * (scaleFactor / 5));

                const position = new THREE.Vector3(x, y, z);
                createManualPulsar(file, position);
            });
        }

        // **NUEVO**: Crea un púlsar individual a partir de un archivo y una posición
        function createManualPulsar(file, position, isFromLoad = false) {
            const pulsarId = `user_${file.name.replace(/[^a-zA-Z0-9]/g, '')}_${Date.now()}`;
            
            // Para la clase RadioNebula, necesitamos un analizador de audio.
            // Lo creamos aquí.
            const analyserNode = audioContext.createAnalyser();
            analyserNode.fftSize = 512;
            
            // Creamos la nebulosa visual
            // Se asume que la clase RadioNebula y sus configuraciones existen en el scope
            const config = window.GALAXY_PULSAR_CONFIG || { baseSize: 80 }; // Fallback config
            const radioNebula = new RadioNebula(scene, position, analyserNode, config, 'mp3');
            radioNebula.isUserCreated = true; // Flag para identificarlo al guardar

            // Creamos el elemento de audio
            const audioElement = new Audio();
            audioElement.src = URL.createObjectURL(file);
            audioElement.crossOrigin = "anonymous";
            audioElement.loop = true;

            // Conectamos el audio al analizador y al sistema de Three.js
            const source = audioContext.createMediaElementSource(audioElement);
            source.connect(analyserNode);
            const positionalAudio = new THREE.PositionalAudio(audioListener);
            positionalAudio.setNodeSource(analyserNode);
            radioNebula.particlesObject.add(positionalAudio);
            
            // Guardamos todo en el gestor de púlsares
            gestorDePulsares.activos[pulsarId] = {
                id: pulsarId,
                nebula: radioNebula,
                audio: audioElement,
                analyser: analyserNode,
                positionalAudio: positionalAudio,
                url: file.name, // Guardamos el nombre del archivo como referencia
                isUserCreated: true,
                isLoaded: true, // Lo marcamos como cargado
                isPlaying: false
            };

            // Si no viene de una carga de archivo, lo reproducimos
            if (!isFromLoad) {
                audioElement.play().catch(e => console.error("Error al reproducir audio manual:", e));
            }
        }

        // **NUEVO**: Guarda la configuración de los púlsares creados por el usuario en un JSON
        function savePulsarMap() {
            const userPulsars = [];
            for (const pulsarId in gestorDePulsares.activos) {
                const pulsar = gestorDePulsares.activos[pulsarId];
                if (pulsar.isUserCreated) {
                    userPulsars.push({
                        fileName: pulsar.url, // Nombre del archivo original
                        position: pulsar.nebula.initialStaticPosition
                    });
                }
            }

            if (userPulsars.length === 0) {
                alert("No hay púlsares creados por el usuario para guardar.");
                return;
            }

            const jsonString = JSON.stringify(userPulsars, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const a = document.createElement('a');
            a.href = url;
            a.download = `musicosmos_map_${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // **NUEVO**: Carga y recrea una configuración de púlsares desde un archivo JSON
        function loadPulsarMap(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const pulsarData = JSON.parse(e.target.result);
                    
                    // Pedimos al usuario que vuelva a seleccionar los archivos de audio necesarios
                    const requiredFiles = pulsarData.map(p => p.fileName).join(', ');
                    alert(`Mapa cargado. Ahora, por favor, selecciona los siguientes archivos de audio en el mismo orden para reconstruir los púlsares:\n\n${requiredFiles}`);

                    // Limpiamos la selección actual para forzar una nueva
                    document.getElementById('audioFilesInput').value = '';
                    document.getElementById('audioFilesInput').addEventListener('change', (evt) => {
                        const loadedFiles = Array.from(evt.target.files);
                        
                        // Verificamos si los archivos coinciden (simplificado)
                        if (loadedFiles.length !== pulsarData.length) {
                            alert("El número de archivos no coincide con el mapa. Inténtalo de nuevo.");
                            return;
                        }

                        // Creamos los púlsares
                        pulsarData.forEach((pulsarInfo, index) => {
                            const audioFile = loadedFiles[index];
                            const position = new THREE.Vector3(pulsarInfo.position.x, pulsarInfo.position.y, pulsarInfo.position.z);
                            // Validamos que el nombre coincida (opcional pero recomendado)
                            if (audioFile.name === pulsarInfo.fileName) {
                                createManualPulsar(audioFile, position, true); // true para no auto-reproducir
                            } else {
                                console.warn(`El archivo ${audioFile.name} no coincide con ${pulsarInfo.fileName} pero se usará de todas formas.`);
                                createManualPulsar(audioFile, position, true);
                            }
                        });
                        alert("¡Universo reconstruido! Puedes iniciar la reproducción desde la playlist o acercándote a los púlsares.");

                    }, { once: true }); // El listener se ejecuta solo una vez

                } catch (error) {
                    alert("Error al leer el archivo del mapa. Asegúrate de que es un JSON válido de Musicosmos.");
                    console.error("Error parsing map JSON:", error);
                }
            };
            reader.readAsText(file);
        }


        // --- Bucle de Animación y otras funciones ---
        function animate() {
            requestAnimationFrame(animate);
            const deltaTime = clock.getDelta();

            // Lógica de movimiento del avatar
            const speed = 20 * deltaTime;
            const direction = new THREE.Vector3(-Math.sin(yawAngle), 0, -Math.cos(yawAngle));
            const rightVector = new THREE.Vector3(direction.z, 0, -direction.x);

            if (moveForward) avatarObject.position.addScaledVector(direction, speed);
            if (moveBackward) avatarObject.position.addScaledVector(direction, -speed);
            if (moveLeft) avatarObject.position.addScaledVector(rightVector, -speed);
            if (moveRight) avatarObject.position.addScaledVector(rightVector, speed);
            if (moveUp) avatarObject.position.y += speed;
            if (moveDown) avatarObject.position.y -= speed;

            updateCameraPosition();
            updateCoordinatesDisplay();

            // Actualizar púlsares existentes
            for (const pulsarId in gestorDePulsares.activos) {
                const pulsar = gestorDePulsares.activos[pulsarId];
                if (pulsar && pulsar.nebula && typeof pulsar.nebula.update === 'function') {
                    // Simular datos de audio si no hay reproducción real para mantenerlos vivos
                    const freqData = new Uint8Array(pulsar.analyser.frequencyBinCount);
                    const timeData = new Uint8Array(pulsar.analyser.fftSize);
                    if (pulsar.isPlaying) {
                        pulsar.analyser.getByteFrequencyData(freqData);
                        pulsar.analyser.getByteTimeDomainData(timeData);
                    }
                    pulsar.nebula.update(freqData, timeData, deltaTime);
                }
            }

            renderer.render(scene, camera);
        }

        // --- Funciones de utilidad y control (onKeyDown, onWindowResize, etc.) ---
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        function onKeyDown(event) {
            switch (event.code) {
                case 'KeyW': moveForward = true; break;
                case 'KeyS': moveBackward = true; break;
                case 'KeyA': moveLeft = true; break;
                case 'KeyD': moveRight = true; break;
                case 'Space': moveUp = true; break;
                case 'ShiftLeft': moveDown = true; break;
            }
        }
        function onKeyUp(event) {
            switch (event.code) {
                case 'KeyW': moveForward = false; break;
                case 'KeyS': moveBackward = false; break;
                case 'KeyA': moveLeft = false; break;
                case 'KeyD': moveRight = false; break;
                case 'Space': moveUp = false; break;
                case 'ShiftLeft': moveDown = false; break;
            }
        }
        
        function updateCameraPosition() {
             const offset = new THREE.Vector3();
             offset.copy(cameraOffset);
             const dir = new THREE.Vector3(-Math.sin(yawAngle), 0, -Math.cos(yawAngle));
             offset.applyAxisAngle(new THREE.Vector3(0,1,0), yawAngle);
             camera.position.copy(avatarObject.position).add(offset);
             camera.lookAt(avatarObject.position);
        }
        
        function updateCoordinatesDisplay() {
            const coordsElement = document.getElementById('coordinates');
            const pos = avatarObject.position;
            coordsElement.textContent = `X: ${pos.x.toFixed(2)}, Y: ${pos.y.toFixed(2)}, Z: ${pos.z.toFixed(2)}`;
        }

        function toggleSettingsMenu() {
            const menu = document.getElementById('settingsMenu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
        }
        function toggleTeleportPanel() {
            const panel = document.getElementById('teleportPanel');
            panel.style.display = panel.style.display === 'block' ? 'none' : 'block';
        }
        function teleportToCoords() {
            const x = parseFloat(document.getElementById('teleportX').value);
            const y = parseFloat(document.getElementById('teleportY').value);
            const z = parseFloat(document.getElementById('teleportZ').value);
            if (!isNaN(x) && !isNaN(y) && !isNaN(z)) {
                avatarObject.position.set(x, y, z);
            }
        }
        function cycleViewMode() { /* Lógica para cambiar vistas */ }

        function initTabs() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(button.dataset.tab).classList.add('active');
                });
            });
        }

        // Se asume que la clase RadioNebula existe y funciona como en el archivo original.
        // Es una clase compleja, por lo que no se replica aquí por brevedad,
        // pero es ESENCIAL para que el código funcione.
        class RadioNebula {
            constructor(scene, initialStaticPosition, analyser, config, type = 'mp3') {
                this.scene = scene;
                this.initialStaticPosition = initialStaticPosition.clone();
                this.analyser = analyser;
                this.config = config;
                this.bufferLength = this.analyser.frequencyBinCount;
                this.particleCount = 5000;
                this.particlesObject = new THREE.Object3D();
                this.particlesObject.position.copy(this.initialStaticPosition);
                this.scene.add(this.particlesObject);
                const geometry = new THREE.BufferGeometry();
                const positions = new Float32Array(this.particleCount * 3);
                const colors = new Float32Array(this.particleCount * 3);
                const sizes = new Float32Array(this.particleCount);
                for (let i = 0; i < this.particleCount; i++) {
                    const i3 = i * 3;
                    const radius = Math.random() * this.config.baseSize;
                    const theta = Math.random() * Math.PI * 2;
                    const phi = Math.acos(2 * Math.random() - 1);
                    positions[i3] = radius * Math.sin(phi) * Math.cos(theta);
                    positions[i3 + 1] = radius * Math.sin(phi) * Math.sin(theta);
                    positions[i3 + 2] = radius * Math.cos(phi);
                    const c = new THREE.Color(0xffffff).setHSL(Math.random(), 0.7, 0.5);
                    colors[i3] = c.r; colors[i3+1] = c.g; colors[i3+2] = c.b;
                    sizes[i] = Math.random() * 5;
                }
                geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
                geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
                geometry.setAttribute('size', new THREE.BufferAttribute(sizes, 1));
                this.geometry = geometry;
                const material = new THREE.PointsMaterial({
                    vertexColors: true, transparent: true, blending: THREE.AdditiveBlending,
                    depthWrite: false, size: 1.0,
                });
                this.points = new THREE.Points(geometry, material);
                this.particlesObject.add(this.points);
            }
            update(freqData, timeData, deltaTime) {
                // Lógica de animación visual del púlsar
                this.points.rotation.y += deltaTime * 0.1;
            }
        }

        // Iniciar la aplicación
        init();

    </script>
</body>
</html>
